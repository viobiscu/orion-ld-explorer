<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Orion-LD Explorer - SensorsReport</title>
    <link href="favicon.ico" type="image/x-icon" rel="icon"/>
    <link href="css/style.css" rel="stylesheet"/>
    
    <!-- Use locally hosted Font Awesome instead of CDN -->
    <link href="fonts/fontawesome/css/all.min.css" rel="stylesheet"/>
    
    <!-- Add highlight.js CSS and JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/json.min.js"></script>
    
    <link href="css/custom-highlight.css" rel="stylesheet"/>
    
    <!-- Load the non-module version of JsonEditor first for global availability -->
    <script src="js/jsonEditor.js"></script>
    <script src="js/TabManager.js"></script>
    
    <script>
        // Create functions that will be needed by modules before they load
        window.passwordVisibility = {
            togglePasswordVisibility: function(fieldId) {
                const input = document.getElementById(fieldId);
                if (input) {
                    input.type = input.type === "password" ? "text" : "password";
                }
            }
        };
        
        window.authChecker = {
            checkAuthentication: function() {
                // This will be replaced by the proper implementation once modules load
                return true;
            }
        };

        // Define handleEntityGet as a window function to avoid conflicts with modules
        window.handleEntityGet = function(url) {
            // Make sure url is a string to prevent /undefined requests
            if (!url || typeof url !== 'string') {
                console.error('handleEntityGet called with invalid URL:', url);
                return;
            }
            
            // Log for debugging
            console.log('handleEntityGet called with URL:', url);
            
            // Save current content if switching to color settings
            if (url === 'inc/colorSettings.html') {
                const displayArea = document.getElementById('displayArea');
                if (displayArea) {
                    localStorage.setItem('previousContent', displayArea.innerHTML);
                }
            }
            
            // Initialize TabManager if it doesn't exist yet
            if (!window.tabManager) {
                console.log('Initializing TabManager for handleEntityGet');
                window.tabManager = new TabManager('#displayArea');
            }
            
            // Extract tab title from URL
            let tabTitle = 'GET Operation';
            if (url.includes('/')) {
                const urlParts = url.split('/');
                const fileName = urlParts[urlParts.length - 1];
                tabTitle = fileName.split('.')[0].charAt(0).toUpperCase() + fileName.split('.')[0].slice(1);
                
                // Make more user-friendly tab titles
                if (tabTitle === 'DataProductsGet') tabTitle = 'GET Data Products';
                else if (tabTitle === 'RelationshipsVisual') tabTitle = 'Visualize Relationships';
                else if (tabTitle === 'ColorSettings') tabTitle = 'Color Settings';
                else if (tabTitle === 'Queue') tabTitle = 'Queues';
                else if (tabTitle === 'Resources') tabTitle = 'Reference';
            }
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch ${url}: ${response.status} ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(data => {
                    // Create a new tab for this content
                    const tabId = `tab-${Date.now()}`;
                    const tab = window.tabManager.createTab(tabTitle, tabId);
                    
                    // Create content container for this tab
                    const contentContainer = document.createElement('div');
                    contentContainer.className = 'editor-tab-content';
                    contentContainer.id = `${tabId}-content`;
                    contentContainer.style.height = '100%';
                    contentContainer.style.display = 'none'; // Hide initially
                    contentContainer.innerHTML = data;
                    
                    // Add the content to the content area
                    window.tabManager.contentArea.appendChild(contentContainer);
                    
                    // Store tab information
                    window.tabManager.tabs.push({
                        id: tabId,
                        tabElement: tab,
                        contentElement: contentContainer,
                        editor: null,
                        mode: 'html'
                    });
                    
                    // Activate the new tab
                    window.tabManager.activateTab(tabId);
                    
                    // Then extract and execute scripts
                    const scriptTags = contentContainer.getElementsByTagName('script');
                    const scripts = Array.from(scriptTags).map(script => script.innerHTML).join('\n');
                    
                    if (scripts) {
                        // Create a new script element for execution
                        const scriptElement = document.createElement('script');
                        scriptElement.textContent = scripts;
                        document.body.appendChild(scriptElement);
                    }
                    
                    // Log the operation
                    if (typeof appendToLogs === 'function') {
                        appendToLogs(`Opened ${tabTitle} in a new tab`);
                    }
                })
                .catch(error => {
                    console.error('Error in handleEntityGet:', error);
                    if (typeof appendToLogs === 'function') {
                        appendToLogs(`Error loading content: ${error.message}`);
                    }
                    
                    // Display error in a new tab
                    const tabId = `error-${Date.now()}`;
                    const tab = window.tabManager.createTab('Error', tabId);
                    
                    // Create content container for this tab
                    const contentContainer = document.createElement('div');
                    contentContainer.className = 'editor-tab-content';
                    contentContainer.id = `${tabId}-content`;
                    contentContainer.style.height = '100%';
                    contentContainer.style.display = 'none'; // Hide initially
                    contentContainer.innerHTML = `<p class="error-message">Error loading content: ${error.message}</p>`;
                    
                    // Add the content to the content area
                    window.tabManager.contentArea.appendChild(contentContainer);
                    
                    // Store tab information
                    window.tabManager.tabs.push({
                        id: tabId,
                        tabElement: tab,
                        contentElement: contentContainer,
                        editor: null,
                        mode: 'error'
                    });
                    
                    // Activate the new tab
                    window.tabManager.activateTab(tabId);
                });
        };

        // Define filterEntitiesByType function to support GET by Type
        window.filterEntitiesByType = function(entityType) {
            console.log(`Filtering entities by type: ${entityType}`);
            
            try {
                // Initialize the OrionLDClient
                if (typeof OrionLDClient !== 'function') {
                    console.error('OrionLDClient is not available');
                    return Promise.reject(new Error('OrionLDClient is not available. Please refresh the page.'));
                }
                
                const client = new OrionLDClient();
                // Add consistent parameters to match the general query pattern (limit, offset, local)
                const endpoint = `/api/ngsi-ld/v1/entities?type=${encodeURIComponent(entityType)}&limit=100&offset=0&local=true`;
                
                // Log the request
                console.log(`Making GET request for entities of type: ${entityType}`);
                if (typeof appendToLogs === 'function') {
                    appendToLogs(`GET request for type: ${entityType}`);
                }
                
                // Return a promise that fetches the entities
                return fetch(endpoint, {
                    method: 'GET',
                    headers: client.headers,
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Server responded with status ${response.status}: ${text}`);
                        });
                    }
                    return response.json();
                });
            } catch (error) {
                console.error('Error in filterEntitiesByType:', error);
                return Promise.reject(error);
            }
        };

        // Define handleGetQuery function to handle entity queries properly
        // This function needs to be exposed globally as it's called by loaded HTML content
        window.handleGetQuery = function(queryParams) {
            console.log('DEBUG: handleGetQuery called in index.html with:', queryParams);
            
            try {
                // Initialize the OrionLDClient
                if (typeof OrionLDClient !== 'function') {
                    console.error('OrionLDClient is not available');
                    throw new Error('OrionLDClient is not available. Please refresh the page.');
                }
                
                const client = new OrionLDClient();
                
                // Determine if this is an entity ID request or a query parameters request
                let endpoint = '/api/ngsi-ld/v1/entities';
                
                // Check for different query formats
                if (queryParams.startsWith('/')) {
                    // Extract entity ID and any remaining parameters
                    const parts = queryParams.substring(1).split('?');
                    const entityId = parts[0];
                    
                    if (entityId) {
                        // If it's a specific entity request
                        endpoint = `/api/ngsi-ld/v1/entities/${entityId}`;
                        
                        // Add any query parameters if present
                        if (parts.length > 1 && parts[1]) {
                            endpoint += `?${parts[1]}`;
                        }
                    }
                } else if (queryParams.startsWith('?')) {
                    // It's a query parameter string, append it to the base endpoint
                    endpoint = `/api/ngsi-ld/v1/entities${queryParams}`;
                } else if (queryParams.startsWith('urn:')) {
                    // This is an entity ID without the leading slash - add it automatically
                    // This is the key fix for the reported error
                    endpoint = `/api/ngsi-ld/v1/entities/${queryParams}`;
                    console.log('Entity ID detected, using endpoint:', endpoint);
                } else {
                    // If no proper format is detected, show an error
                    const errorMsg = {
                        error: 'Invalid query format. Must start with ? for query parameters, / for entity ID, or be a valid urn: entity ID.',
                        example: '?type=Device or /urn:ngsi-ld:Device:001 or urn:ngsi-ld:Device:001'
                    };
                    
                    // Display error in both editors if available
                    if (window.mainEditor) {
                        window.mainEditor.setValue(JSON.stringify(errorMsg, null, 2));
                    }
                    
                    // Also update the GET results editor if it exists
                    if (window.getResultsEditor) {
                        window.getResultsEditor.setValue(JSON.stringify(errorMsg, null, 2));
                    }
                    
                    return;
                }
                
                // Show loading indicator in both editors
                if (window.mainEditor) {
                    window.mainEditor.setValue("Loading data...");
                }
                
                if (window.getResultsEditor) {
                    window.getResultsEditor.setValue("Loading data...");
                    // Add loading indicator to the results area header if it exists
                    const resultsHeader = document.querySelector('.get-results-header');
                    if (resultsHeader) {
                        const loadingSpinner = document.createElement('span');
                        loadingSpinner.className = 'loading-spinner';
                        loadingSpinner.style.marginLeft = 'auto';
                        loadingSpinner.style.width = '20px';
                        loadingSpinner.style.height = '20px';
                        loadingSpinner.style.border = '2px solid #ccc';
                        loadingSpinner.style.borderTopColor = '#333';
                        loadingSpinner.style.borderRadius = '50%';
                        loadingSpinner.style.animation = 'spin 1s linear infinite';
                        resultsHeader.appendChild(loadingSpinner);
                    }
                } else {
                    // If getResultsEditor doesn't exist, show a loading indicator in the displayArea
                    const displayArea = document.getElementById('displayArea');
                    if (displayArea) {
                        const loadingDiv = document.createElement('div');
                        loadingDiv.className = 'loading-indicator';
                        loadingDiv.textContent = 'Loading data...';
                        
                        // Keep the form but add loading indicator
                        const mainJsonEditor = document.getElementById('mainJsonEditorContainer');
                        if (mainJsonEditor) {
                            mainJsonEditor.style.display = 'none';
                            displayArea.appendChild(loadingDiv);
                        } else {
                            displayArea.innerHTML = '<div class="loading-indicator">Loading data...</div>';
                        }
                    }
                }
                
                // Log the request
                console.log(`Making GET request to: ${endpoint}`);
                if (typeof appendToLogs === 'function') {
                    appendToLogs(`GET request: ${endpoint}`);
                }
                
                // Make the request
                fetch(endpoint, {
                    method: 'GET',
                    headers: client.headers,
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Server responded with status ${response.status}: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Format the data with proper indentation
                    const formattedData = JSON.stringify(data, null, 2);
                    
                    // Remove loading spinners
                    const loadingSpinner = document.querySelector('.loading-spinner');
                    if (loadingSpinner) {
                        loadingSpinner.remove();
                    }
                    
                    const loadingIndicator = document.querySelector('.loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    // Show the JSON editor again if it was hidden
                    const mainJsonEditor = document.getElementById('mainJsonEditorContainer');
                    if (mainJsonEditor) {
                        mainJsonEditor.style.display = 'block';
                    }
                    
                    // Update both editors with the response data
                    if (window.mainEditor) {
                        window.mainEditor.setValue(formattedData);
                    }
                    
                    // PRIORITY: Update the dedicated GET results editor
                    if (window.getResultsEditor) {
                        window.getResultsEditor.setValue(formattedData);
                        
                        // Highlight the results area to show new data has arrived
                        const resultsArea = document.querySelector('.get-results-area');
                        if (resultsArea) {
                            resultsArea.style.animation = 'highlight-pulse 1s';
                            setTimeout(() => {
                                resultsArea.style.animation = '';
                            }, 1000);
                        }
                    } else if (displayArea) {
                        // Fallback to a simple pre/code block if the JSON editor is not available
                        displayArea.innerHTML = `<pre id="jsonDisplay"><code class="language-json">${formattedData}</code></pre>`;
                        
                        // Apply syntax highlighting if available
                        if (typeof hljs !== 'undefined') {
                            document.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightElement(block);
                            });
                        }
                    }
                    
                    if (typeof appendToLogs === 'function') {
                        appendToLogs(`Response received for ${endpoint}`);
                    }
                })
                .catch(error => {
                    console.error('Error in handleGetQuery:', error);
                    
                    // Format the error as JSON
                    const errorData = JSON.stringify({
                        error: error.message,
                        endpoint: endpoint,
                        timestamp: new Date().toISOString()
                    }, null, 2);
                    
                    // Remove loading indicators
                    const loadingSpinner = document.querySelector('.loading-spinner');
                    if (loadingSpinner) {
                        loadingSpinner.remove();
                    }
                    
                    const loadingIndicator = document.querySelector('.loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    // Show the JSON editor again if it was hidden
                    const mainJsonEditor = document.getElementById('mainJsonEditorContainer');
                    if (mainJsonEditor) {
                        mainJsonEditor.style.display = 'block';
                    }
                    
                    // Update both editors with the error
                    if (window.mainEditor) {
                        window.mainEditor.setValue(errorData);
                    }
                    
                    if (window.getResultsEditor) {
                        window.getResultsEditor.setValue(errorData);
                        
                        // Highlight the results area to show error
                        const resultsArea = document.querySelector('.get-results-area');
                        if (resultsArea) {
                            resultsArea.style.animation = 'highlight-error 1s';
                            resultsArea.style.borderColor = '#f44336';
                            setTimeout(() => {
                                resultsArea.style.animation = '';
                                resultsArea.style.borderColor = '';
                            }, 3000);
                        }
                    } else if (displayArea) {
                        displayArea.innerHTML = `<p class="error-message">Error: ${error.message}</p>`;
                    }
                    
                    if (typeof appendToLogs === 'function') {
                        appendToLogs(`Error in request: ${error.message}`);
                    }
                });
            } catch (error) {
                console.error('Unexpected error in handleGetQuery:', error);
                
                if (window.getResultsEditor) {
                    window.getResultsEditor.setValue(JSON.stringify({
                        unexpectedError: error.message,
                        stack: error.stack,
                        timestamp: new Date().toISOString()
                    }, null, 2));
                }
            }
        };

        // Function to open the JSON editor directly with specified mode
        function openEntityEditor(mode) {
            console.log(`Opening JSON editor directly in ${mode} mode`);
            
            // Initialize TabManager if it doesn't exist yet
            if (!window.tabManager) {
                console.log('Initializing TabManager');
                window.tabManager = new TabManager('#displayArea');
            }
            
            // Initial entity templates based on mode
            const entityTemplate = getEntityTemplate(mode);
            
            // Get saved values if available
            let entityId = '';
            let initialValue = null;
            
            // Try to load saved values for the current mode
            const savedJson = localStorage.getItem(`entity${mode.charAt(0).toUpperCase() + mode.slice(1)}Json`);
            const savedEntityId = localStorage.getItem(`entity${mode.charAt(0).toUpperCase() + mode.slice(1)}Id`);
            
            if (savedJson) {
                try {
                    initialValue = JSON.parse(savedJson);
                } catch (e) {
                    console.warn('Could not parse saved JSON, using template instead', e);
                    initialValue = entityTemplate;
                }
            } else {
                initialValue = entityTemplate;
            }
            
            // Use saved entity ID for all suitable modes
            if (savedEntityId && ['get', 'put', 'patch', 'delete'].includes(mode)) {
                entityId = savedEntityId;
            } else if (['put', 'patch'].includes(mode)) {
                // For PUT/PATCH, extract ID from template if no saved ID
                entityId = initialValue.id || '';
            }
            
            // Create tab title based on the mode
            const tabTitle = `${mode.toUpperCase()} Entity`;
            
            // Create editor options
            const editorOptions = {
                initialValue: JSON.stringify(initialValue, null, 2),
                height: 500,
                resize: true,
                mode: mode,
                entityId: entityId,
                operation: mode.toUpperCase(), // Explicitly set the operation type to trigger API buttons
                allowEntityIdEdit: true,       // Allow editing the entity ID
                onApiOperation: function(operation, entityId, data) {
                    console.log(`API operation called: ${operation} on entity ${entityId}`);
                    
                    // Handler for different operations
                    if (operation === 'GET') {
                        if (typeof window.handleGetQuery === 'function') {
                            console.log(`Handling GET for ${entityId}`);
                            window.handleGetQuery(entityId);
                            return { success: true };
                        }
                    } else if (operation === 'POST') {
                        if (typeof window.processPostQuery === 'function') {
                            return window.processPostQuery(JSON.stringify(data));
                        }
                    } else if (operation === 'PUT') {
                        if (typeof window.processPutQuery === 'function') {
                            return window.processPutQuery(entityId, JSON.stringify(data));
                        }
                    } else if (operation === 'PATCH') {
                        if (typeof window.processPatchQuery === 'function') {
                            return window.processPatchQuery(entityId, JSON.stringify(data));
                        }
                    } else if (operation === 'DELETE') {
                        if (confirm(`Are you sure you want to delete entity "${entityId}"? This action cannot be undone.`)) {
                            if (typeof window.processDeleteQuery === 'function') {
                                return window.processDeleteQuery(entityId);
                            }
                        }
                    }
                    
                    console.error(`No handler for ${operation} operation`);
                    return { error: true, message: `Handler for ${operation} not available` };
                },
                onSave: function(value) {
                    try {
                        const parsedValue = JSON.parse(value);
                        // Save to localStorage for persistence
                        localStorage.setItem(`entity${mode.charAt(0).toUpperCase() + mode.slice(1)}Json`, JSON.stringify(parsedValue));
                        console.log(`Saved ${mode} JSON to localStorage`);
                    } catch (e) {
                        console.error('Error saving JSON to localStorage:', e);
                    }
                }
            };
            
            // Create a new tab with the editor
            const tabId = window.tabManager.createEditorTab(tabTitle, editorOptions);
            console.log(`Created new tab with ID: ${tabId} for ${mode} mode`);
            
            // For backward compatibility, set window.entityEditor to the new editor
            const tab = window.tabManager.getTabById(tabId);
            if (tab && tab.editor) {
                window.entityEditor = tab.editor;
                
                // For GET mode, also set the getResultsEditor reference
                if (mode === 'get') {
                    window.getResultsEditor = tab.editor;
                }
            }
            
            // Log the operation
            if (typeof appendToLogs === 'function') {
                appendToLogs(`Opened ${mode.toUpperCase()} Entity editor in a new tab`);
            }
        }
        
        // Helper function to get operation description
        function getOperationDescription(mode) {
            const descriptions = {
                'post': "This form creates a new entity in the Orion-LD Context Broker.",
                'put': "This form replaces an existing entity in the Orion-LD Context Broker.",
                'patch': "This form updates specific fields of an existing entity in the Orion-LD Context Broker."
            };
            return descriptions[mode] || '';
        }
        
        // Helper function to get entity template based on mode
        function getEntityTemplate(mode) {
            const uuid = generateUuid();
            const now = new Date().toISOString();
            
            const templates = {
                'get': {
                    "id": "",
                    "type": "",
                    "@context": [
                        "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
                    ]
                },
                'post': {
                    "id": "urn:ngsi-ld:Entity:" + uuid,
                    "type": "Device",
                    "@context": [
                        "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
                    ],
                    "name": {
                        "type": "Property",
                        "value": "New Entity"
                    },
                    "timestamp": {
                        "type": "Property",
                        "value": now
                    }
                },
                'put': {
                    "id": "urn:ngsi-ld:Entity:" + uuid,
                    "type": "Device",
                    "@context": [
                        "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
                    ],
                    "name": {
                        "type": "Property",
                        "value": "Updated Entity"
                    },
                    "timestamp": {
                        "type": "Property",
                        "value": now
                    },
                    "status": {
                        "type": "Property",
                        "value": "active"
                    }
                },
                'patch': {
                    "name": {
                        "type": "Property",
                        "value": "Patched Entity Name"
                    },
                    "timestamp": {
                        "type": "Property",
                        "value": now
                    }
                }
            };
            
            return templates[mode] || templates.post;
        }
        
        // Generate a UUID for entity IDs
        function generateUuid() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // Handle entity operations (Create, Update, Patch)
        function handleEntityAction(action) {
            try {
                console.log('Entity action:', action);
                
                if (!action.data) {
                    throw new Error('No entity data provided.');
                }
                
                // For PUT and PATCH, verify entity ID is provided
                if (['put', 'patch'].includes(action.mode) && !action.entityId) {
                    throw new Error('Entity ID is required for PUT and PATCH operations.');
                }
                
                // Save entity ID to localStorage
                if (action.entityId) {
                    localStorage.setItem(`entity${action.mode.charAt(0).toUpperCase() + action.mode.slice(1)}Id`, action.entityId);
                }
                
                // Handle different operations
                switch (action.mode) {
                    case 'post':
                        console.log('Creating entity:', action.data);
                        // Call the API function for entity creation
                        if (typeof window.processPostQuery === 'function') {
                            window.processPostQuery(JSON.stringify(action.data));
                        } else {
                            console.error('processPostQuery function not available');
                            alert('API function for entity creation is not available.');
                        }
                        break;
                        
                    case 'put':
                        console.log(`Updating entity ${action.entityId}:`, action.data);
                        // Call the API function for entity update
                        if (typeof window.processPutQuery === 'function') {
                            window.processPutQuery(action.entityId, JSON.stringify(action.data));
                        } else {
                            console.error('processPutQuery function not available');
                            alert('API function for entity update is not available.');
                        }
                        break;
                        
                    case 'patch':
                        console.log(`Patching entity ${action.entityId}:`, action.data);
                        // Call the API function for entity patch
                        if (typeof window.processPatchQuery === 'function') {
                            window.processPatchQuery(action.entityId, JSON.stringify(action.data));
                        } else {
                            console.error('processPatchQuery function not available');
                            alert('API function for entity patch is not available.');
                        }
                        break;
                        
                    default:
                        throw new Error(`Unsupported operation mode: ${action.mode}`);
                }
                
                if (typeof appendToLogs === 'function') {
                    appendToLogs(`${action.mode.toUpperCase()} operation executed for ${action.entityId || 'new entity'}`);
                }
                
            } catch (error) {
                console.error('Error performing entity operation:', error);
                alert('Error: ' + error.message);
            }
        }
    </script>
    
    <!-- Load our scripts with defer attribute and module type -->
    <script src="js/auth-backend.js" type="module" defer></script>
    <script src="js/ui.js" type="module" defer></script>
    <script src="js/api.js" type="module" defer></script>
    <script src="js/AppInitializer.js" type="module" defer></script>
    <script src="js/colorSettings.js" type="module" defer></script>
    
    <!-- Added styles for json-editor -->
    <style>
      #mainJsonEditorContainer {
        width: 100%;
        height: 500px;
        margin: 0;
      }
      
      /* Hide Subscriptions section */
      .hide-subscriptions {
        display: none !important;
      }
      
      /* Fallback for Font Awesome icons if they fail to load */
      .icon-fallback-text {
        display: inline-block;
        margin-right: 5px;
      }

      /* Info labels for user and tenant in header */
      .info-label {
        font-weight: 500;
        margin-right: 10px;
      }
      
      /* Container for tenant label and input */
      .tenant-container {
        display: flex;
        align-items: center;
        margin: 0 15px;
      }
      
      /* Error message styling */
      .network-error {
        background-color: #fff3cd;
        color: #856404;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        border: 1px solid #ffeeba;
      }
      
      /* Token dialog styling */
      #tokenDialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 800px;
        background: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 1000;
        border-radius: 4px;
        padding: 20px;
        display: none;
      }
      
      #tokenDialog .dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      
      #tokenDialog .close-button {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
      }
      
      #tokenDialog .dialog-content {
        max-height: 60vh;
        overflow-y: auto;
      }
      
      #dialogOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 999;
        display: none;
      }
      
      /* Loading indicator */
      .loading-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        font-size: 1.2em;
        color: #666;
      }
      
      .loading-indicator::after {
        content: '';
        width: 1em;
        height: 1em;
        border: 0.2em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        margin-left: 0.5em;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Toolbar styling */
      .toolbar {
        display: flex;
        gap: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 10px;
      }
      
      .toolbar button {
        padding: 6px 12px;
        border-radius: 4px;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
      }
      
      .toolbar button:hover {
        opacity: 0.9;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .toolbar button i {
        font-size: 16px;
      }
      
      /* Editor tabs styling */
      .editor-tabs-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
      }
      
      .editor-tabs-bar {
        display: flex;
        background-color: #f0f0f0;
        border-bottom: 1px solid #ddd;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
      }
      
      .editor-tab {
        display: inline-flex;
        align-items: center;
        padding: 8px 12px;
        border-right: 1px solid #ddd;
        cursor: pointer;
        user-select: none;
        position: relative;
        max-width: 200px;
        transition: background-color 0.2s ease;
      }
      
      .editor-tab:hover {
        background-color: #e9e9e9;
      }
      
      .editor-tab.active {
        background-color: #fff;
        border-bottom: 2px solid #007bff;
      }
      
      .tab-close-btn {
        margin-left: 8px;
        font-weight: bold;
        font-size: 16px;
        line-height: 1;
        cursor: pointer;
        padding: 0 4px;
        border-radius: 50%;
        color: #666;
      }
      
      .tab-close-btn:hover {
        background-color: #ddd;
        color: #333;
      }
      
      .editor-tabs-content {
        flex-grow: 1;
        overflow: hidden;
        position: relative;
      }
      
      .editor-tab-content {
        height: 100%;
        display: none;
      }
      
      .editor-tab-content.active {
        display: block;
      }
    </style>
</head>
<body>
    <!-- Add login form section before the main content -->
    <div id="loginFormContainer" class="login-container" style="display: none;">
      <div class="login-form">
        <h2>Login to SensorsReport</h2>
        <form id="loginForm">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required>
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required>
          </div>
          <div class="form-group">
            <button type="submit" id="loginSubmit">Login</button>
          </div>
          <div id="loginError" class="error-message" style="display: none;"></div>
        </form>
      </div>
    </div>

    <!-- Header Section -->
    <header id="top-header">
        <div class="branding">
            <img alt="SensorsReport Logo" id="brandLogo" src="images/SensorsReport.jpg" loading="lazy"/>
        </div>
        <div class="user-info">
            <span id="loginUser" class="info-label">User: Not logged in</span>
            <div class="tenant-container">
                <span id="tenantName" class="info-label">Tenant:</span>
                <input id="tenantname" placeholder="tenantname" type="text"/>
            </div>
            <button id="showTokenButton" class="method-button patch-button">Show Token</button>
            <button id="clearAuthButton" class="method-button put-button">Clear Auth</button>
            <button id="clearAllButton" class="method-button post-button">Clear All</button>
            <button id="logoutButton" class="method-button delete-button">Logout</button>
        </div>
    </header>

    <!-- Main Container -->
    <div id="main-container">
        <!-- Sidebar Navigation -->
        <aside id="sidebar">
            <ul class="treeview">
                <li class="treeview-item expandable">
                    <i class="fa-regular fa-folder-closed custom-icon"></i><span>Entities</span>
                </li>
                <ul class="nested">
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Entities</span>
                        <button class="method-button get-button" onclick="openEntityEditor('get')">GET</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Entities</span>
                        <button class="method-button post-button" onclick="openEntityEditor('post')">POST</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Entities</span>
                        <button class="method-button put-button" onclick="openEntityEditor('put')">PUT</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Entities</span>
                        <button class="method-button patch-button" onclick="openEntityEditor('patch')">PATCH</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Entities</span>
                        <button class="method-button delete-button" onclick="processDeleteData('/entities{entityId}', '/urn:ngsi-ld:???')">DELETE</button>
                    </li>
                    <li class="treeview-item expandable">
                        <i class="fa-regular fa-folder-closed custom-icon"></i><span>By Type</span>
                    </li>
                    <ul class="nested" id="entity-types-list">
                        <li>
                            <i class="fa-regular fa-file custom-icon"></i><span>Loading types...</span>
                        </li>
                    </ul>
                </ul>

                <li class="treeview-item expandable">
                    <i class="fa-regular fa-folder-closed custom-icon"></i><span>Attributes</span>
                </li>
                <ul class="nested">
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Attributes</span>
                        <button class="method-button get-button" onclick="processGetData('/attributes{attributeId}', '/urn:ngsi-ld:???')">GET</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Attributes</span>
                        <button class="method-button patch-button" onclick="handleEntityGet('inc/attributesPatch.html')">PATCH</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Attributes</span>
                        <button class="method-button delete-button" onclick="processDeleteData('/attributes', '/urn:ngsi-ld:???')">DELETE</button>
                    </li>
                </ul>

                <li class="treeview-item expandable">
                    <i class="fa-regular fa-folder-closed custom-icon"></i><span>Data Products</span>
                </li>
                <ul class="nested">
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Data Products</span>
                        <button class="method-button get-button" onclick="handleEntityGet('inc/dataProductsGet.html')">GET</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Data Products</span>
                        <button class="method-button post-button" onclick="handleEntityGet('inc/dataProductsPost.html')">POST</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Data Products</span>
                        <button class="method-button patch-button" onclick="handleEntityGet('inc/dataProductsPatch.html')">PATCH</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Data Products</span>
                        <button class="method-button delete-button" onclick="handleEntityGet('inc/dataProductsDelete.html')">DELETE</button>
                    </li>
                </ul>

                <li class="treeview-item expandable">
                    <i class="fa-regular fa-folder-closed custom-icon"></i><span>Relationships</span>
                </li>
                <ul class="nested">
                    <li>
                        <i class="fa-regular fa-diagram-project custom-icon"></i><span>Relationships</span>
                        <button class="method-button get-button" onclick="handleEntityGet('inc/relationshipsVisual.html')">VISUALIZE</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Get my Parents</span>
                        <button class="method-button get-button" onclick="processGetData('/relationships?type=parent', '/urn:ngsi-ld:???')">GET</button>
                    </li>
                    <li>
                        <i class="fa-regular fa-file custom-icon"></i><span>Get my Children</span>
                        <button class="method-button get-button" onclick="processGetData('/relationships?type=child', '/urn:ngsi-ld:???')">GET</button>
                    </li>
                </ul>

                <li class="treeview-item">
                    <i class="fa-regular fa-file custom-icon"></i>
                    <span onclick="handleEntityGet('inc/queue.html')">Queues</span>
                </li>
                <li class="treeview-item">
                    <i class="fa-regular fa-file custom-icon"></i>
                    <span onclick="handleEntityGet('inc/resources.html')">Reference</span>
                </li>
                <li class="treeview-item">
                    <i class="fa-regular fa-palette custom-icon"></i>
                    <span onclick="handleEntityGet('inc/colorSettings.html')">Color Settings</span>
                </li>
            </ul>
        </aside>

        <!-- Resizer bar -->
        <div id="resizer"></div>

        <!-- Content Area -->
        <main id="contentArea">
            <div id="displayArea">
                <div id="mainJsonEditorContainer"></div>
            </div>
            <div id="fallbackUI"></div>
            <!-- Logs Section -->
            <div id="logs-container">
                <button class="method-button delete-button" id="clearLogsBtn">Clear Logs</button>
                <button class="method-button patch-button" id="toggleLogsBtn">Hide Logs</button>
                <div id="request-logs">
                    <p class="log-placeholder">Logs will appear here...</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Comment out the old token dialog markup since we're using the one in auth-backend.js -->
    <!-- <div id="dialogOverlay"></div>
    <div id="tokenDialog">
        <div class="dialog-header">
            <h3>Authentication Token</h3>
            <button class="close-button" onclick="closeTokenDialog()">&times;</button>
        </div>
        <div class="dialog-content">
            <div id="tokenEditorContainer"></div>
        </div>
    </div> -->
    
    <script>
        // Initialize the main JSON editor when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize TabManager first
            initializeTabManager();
            
            // Setup token dialog
            setupTokenButton();
            
            // Setup Clear Auth and Clear All buttons
            setupClearButtons();
        });

        // Function to initialize TabManager and load GET Entities tab
        function initializeTabManager() {
            console.log('Initializing TabManager');
            
            // Create TabManager
            window.tabManager = new TabManager('#displayArea');
            
            // Create a default welcome tab instead of loading entitiesGet.html
            const welcomeTabId = `welcome-tab-${Date.now()}`;
            const welcomeTab = window.tabManager.createTab('Welcome', welcomeTabId);
            
            // Create content container for welcome tab
            const contentContainer = document.createElement('div');
            contentContainer.className = 'editor-tab-content';
            contentContainer.id = `${welcomeTabId}-content`;
            contentContainer.style.height = '100%';
            contentContainer.style.display = 'none'; // Hide initially
            
            // Add welcome content
            contentContainer.innerHTML = `
                <div style="padding: 20px;">
                    <h2>Welcome to SensorsReport</h2>
                    <p>This interface allows you to interact with the Orion-LD Context Broker.</p>
                    <p>Use the sidebar navigation to:</p>
                    <ul>
                        <li>Create, update, and delete entities</li>
                        <li>Work with data products</li>
                        <li>Visualize entity relationships</li>
                        <li>Access queue management</li>
                    </ul>
                    <p>Select an operation from the sidebar to get started.</p>
                </div>
            `;
            
            // Add the content to the content area
            window.tabManager.contentArea.appendChild(contentContainer);
            
            // Store tab information
            window.tabManager.tabs.push({
                id: welcomeTabId,
                tabElement: welcomeTab,
                contentElement: contentContainer,
                editor: null,
                mode: 'html'
            });
            
            // Activate the welcome tab
            window.tabManager.activateTab(welcomeTabId);
        }
        
        // Function to switch between entity operation modes
        function switchToMode(mode) {
            // This function will be called from the sidebar navigation
            // It will be handled by the entitiesOperations.html page once loaded
            console.log(`Switching to entity operation mode: ${mode}`);
            
            // Set a small delay to ensure the page has loaded
            setTimeout(() => {
                if (typeof window.switchToMode === 'function') {
                    // Call the switchToMode function in the entitiesOperations.html page
                    window.switchToMode(mode);
                } else {
                    console.error('switchToMode function not available in the loaded page');
                }
            }, 300);
        }
        
        // Function to set up the Clear Auth and Clear All buttons
        function setupClearButtons() {
            // Set up Clear Auth button
            const clearAuthButton = document.getElementById('clearAuthButton');
            if (clearAuthButton) {
                clearAuthButton.addEventListener('click', function() {
                    clearAuthData();
                });
            }
            
            // Set up Clear All button
            const clearAllButton = document.getElementById('clearAllButton');
            if (clearAllButton) {
                clearAllButton.addEventListener('click', function() {
                    clearAllData();
                });
            }
        }
        
        // Function to clear authentication data
        function clearAuthData() {
            // Remove authentication-related items from localStorage
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_info');
            localStorage.removeItem('login_timestamp');
            
            // Update the UI to reflect that the user is logged out
            const loginUserSpan = document.getElementById('loginUser');
            if (loginUserSpan) {
                loginUserSpan.textContent = 'User: Not logged in';
            }
            
            // Log the action
            console.log('Authentication data cleared');
            if (typeof appendToLogs === 'function') {
                appendToLogs('Authentication data cleared');
            }
            
            // Show a message in the editor
            if (window.mainEditor) {
                window.mainEditor.setValue(JSON.stringify({
                    message: "Authentication data cleared",
                    status: "success",
                    timestamp: new Date().toISOString()
                }, null, 2));
            }
            
            // Optionally reload the page to ensure all auth-dependent components are reset
            if (confirm('Authentication data cleared. Would you like to reload the page to complete the logout process?')) {
                window.location.reload();
            }
        }
        
        // Function to clear all localStorage data
        function clearAllData() {
            // Create a backup of non-auth data if user wants to keep it
            const confirm_clear = confirm('This will clear ALL local storage data, including saved queries, settings, and authentication. Continue?');
            
            if (confirm_clear) {
                // Clear all localStorage data
                localStorage.clear();
                
                // Log the action
                console.log('All localStorage data cleared');
                if (typeof appendToLogs === 'function') {
                    appendToLogs('All localStorage data cleared');
                }
                
                // Show a message in the editor
                if (window.mainEditor) {
                    window.mainEditor.setValue(JSON.stringify({
                        message: "All localStorage data cleared",
                        status: "success",
                        timestamp: new Date().toISOString()
                    }, null, 2));
                }
                
                // Reload the page to reset all components
                if (confirm('All data cleared. Reload the page now?')) {
                    window.location.reload();
                }
            }
        }
        
        function setupTokenButton() {
            const showTokenButton = document.getElementById('showTokenButton');
            if (showTokenButton) {
                showTokenButton.addEventListener('click', function() {
                    showTokenDialog();
                });
            }
        }
        
        function showTokenDialog() {
            // Check if AuthBackend is already available
            if (typeof window.AuthBackend !== 'undefined' && typeof window.AuthBackend.showToken === 'function') {
                console.log('Using showToken from auth-backend.js');
                window.AuthBackend.showToken();
                return;
            }
            
            console.log('AuthBackend.showToken is not available - waiting for module to load');
            
            // Implement a more robust retry mechanism with multiple attempts
            let attempts = 0;
            const maxAttempts = 5;
            const retryInterval = 500; // 500ms between attempts
            
            const tryShowToken = function() {
                attempts++;
                if (typeof window.AuthBackend !== 'undefined' && typeof window.AuthBackend.showToken === 'function') {
                    console.log(`AuthBackend.showToken available after ${attempts} attempts`);
                    window.AuthBackend.showToken();
                } else if (attempts < maxAttempts) {
                    console.log(`Retry attempt ${attempts}/${maxAttempts} for AuthBackend.showToken`);
                    setTimeout(tryShowToken, retryInterval);
                } else {
                    console.error(`AuthBackend.showToken still not available after ${maxAttempts} attempts`);
                    
                    // Create fallback token display
                    const token = localStorage.getItem('access_token') || localStorage.getItem('auth_token');
                    if (token) {
                        alert('Token is available but the display functionality is not ready. Using simple display instead.');
                        if (window.mainEditor) {
                            window.mainEditor.setValue(JSON.stringify({
                                message: "Authentication Token (Simple View)",
                                token_preview: token.substring(0, 15) + '...' + token.substring(token.length - 10),
                                note: "This is a simplified view. The full token viewer is not available."
                            }, null, 2));
                        }
                    } else {
                        alert('Token display functionality is not available and no token was found in localStorage.');
                    }
                }
            };
            
            // Start the retry process
            tryShowToken();
        }
        
        // OrionLDClient class for making API requests
        class OrionLDClient {
            constructor() {
                this.baseUrl = '';  // Base URL is relative to allow for different deployments
                this.headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };
                
                // Add authentication token if available
                const token = localStorage.getItem('auth_token');
                if (token) {
                    this.headers['Authorization'] = `Bearer ${token}`;
                }
                
                // Add tenant header if available
                const tenant = document.getElementById('tenantname')?.value;
                if (tenant) {
                    this.headers['NGSILD-Tenant'] = tenant;
                }
            }
        }
        
        // Function to append logs to the log container
        function appendToLogs(message) {
            const logsContainer = document.getElementById('request-logs');
            if (logsContainer) {
                const logItem = document.createElement('p');
                logItem.className = 'log-item';
                
                // Add timestamp
                const timestamp = new Date().toLocaleTimeString();
                logItem.textContent = `[${timestamp}] ${message}`;
                
                // Prepend to show newest logs at the top
                logsContainer.insertBefore(logItem, logsContainer.firstChild);
                
                // Remove placeholder if present
                const placeholder = logsContainer.querySelector('.log-placeholder');
                if (placeholder) {
                    placeholder.remove();
                }
            }
        }
    </script>
</body>

</html>
