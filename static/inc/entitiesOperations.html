<div class="form-container">
  <div class="form-header">
    <div class="entity-operation-selector">
      <button class="method-button get-button" onclick="switchToMode('get')">GET</button>
      <button class="method-button post-button" onclick="switchToMode('post')">POST</button>
      <button class="method-button put-button" onclick="switchToMode('put')">PUT</button>
      <button class="method-button patch-button" onclick="switchToMode('patch')">PATCH</button>
      <button class="method-button delete-button" onclick="switchToMode('delete')">DELETE</button>
    </div>
  </div>
  <div class="form-body">
    <div id="jsonEditorContainer"></div>
  </div>
  <div class="form-footer">
    <small id="operationDescription">This form lets you create, update or patch entities in the Orion-LD Context Broker.</small>
  </div>
</div>

<script>
  // Add styles for the entity operation selector
  (function() {
    const style = document.createElement('style');
    style.textContent = `
      .entity-operation-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .method-button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        color: white;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      .method-button:hover {
        opacity: 0.9;
      }
      .get-button {
        background-color: #5CB85C;
      }
      .post-button {
        background-color: #4CAF50;
      }
      .put-button {
        background-color: #2196F3;
      }
      .patch-button {
        background-color: #FF9800;
      }
      .delete-button {
        background-color: #D9534F;
      }
      .method-button.active {
        box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
      }
      .entity-id-input {
        margin-top: 15px;
        padding: 8px;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    `;
    document.head.appendChild(style);
  })();

  // Global variables
  let currentMode = 'post'; // Default mode
  let editorInstance = null;
  
  // Initial entity templates
  const entityTemplates = {
    get: {
      "message": "Enter an entity ID or query parameters above and click GET",
      "examples": {
        "by_id": "urn:ngsi-ld:Entity:example-001",
        "by_query": "?type=Device&limit=10",
        "by_property": "?q=temperature>20"
      }
    },
    post: {
      "id": "urn:ngsi-ld:Entity:" + generateUuid(),
      "type": "Device",
      "@context": [
        "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
      ],
      "name": {
        "type": "Property",
        "value": "New Entity"
      },
      "timestamp": {
        "type": "Property",
        "value": new Date().toISOString()
      }
    },
    put: {
      "id": "urn:ngsi-ld:Entity:" + generateUuid(),
      "type": "Device",
      "@context": [
        "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld"
      ],
      "name": {
        "type": "Property",
        "value": "Updated Entity"
      },
      "timestamp": {
        "type": "Property",
        "value": new Date().toISOString()
      },
      "status": {
        "type": "Property",
        "value": "active"
      }
    },
    patch: {
      "name": {
        "type": "Property",
        "value": "Patched Entity Name"
      },
      "timestamp": {
        "type": "Property",
        "value": new Date().toISOString()
      }
    },
    delete: {
      "message": "Enter an entity ID above and click DELETE to remove the entity",
      "warning": "This operation cannot be undone"
    }
  };
  
  // Operation descriptions
  const descriptions = {
    get: "This form retrieves entities from the Orion-LD Context Broker. Enter an entity ID or query parameters.",
    post: "This form creates a new entity in the Orion-LD Context Broker.",
    put: "This form replaces an existing entity in the Orion-LD Context Broker.",
    patch: "This form updates specific fields of an existing entity in the Orion-LD Context Broker.",
    delete: "This form deletes an entity from the Orion-LD Context Broker. This action cannot be undone."
  };

  // Generate a UUID for entity IDs
  function generateUuid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  // Initialize the page when loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Try to restore the last active mode from localStorage
    const savedMode = localStorage.getItem('entityOperationMode');
    if (savedMode && ['get', 'post', 'put', 'patch', 'delete'].includes(savedMode)) {
      currentMode = savedMode;
    }
    
    // Initialize the editor with the current mode
    initializeEditor();
    
    // Update UI to reflect current mode
    updateActiveButton();
  });

  // Switch between different operation modes (GET, POST, PUT, PATCH, DELETE)
  function switchToMode(mode) {
    if (mode === currentMode) return;
    
    // Save current mode
    currentMode = mode;
    localStorage.setItem('entityOperationMode', mode);
    
    // Update UI
    updateActiveButton();
    updateDescription();
    
    // Reinitialize the editor with the new mode
    initializeEditor();
  }
  
  // Update the active button highlight
  function updateActiveButton() {
    // Remove active class from all buttons
    document.querySelectorAll('.method-button').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Add active class to the current mode button
    const activeButton = document.querySelector(`.${currentMode}-button`);
    if (activeButton) {
      activeButton.classList.add('active');
    }
  }
  
  // Update the operation description
  function updateDescription() {
    const descriptionEl = document.getElementById('operationDescription');
    if (descriptionEl) {
      descriptionEl.textContent = descriptions[currentMode] || '';
    }
  }

  // Initialize or re-initialize the JSON editor
  function initializeEditor() {
    // Load localStorage values if available
    let entityId = '';
    let initialValue = null;
    
    // Try to load saved values for the current mode
    const savedJson = localStorage.getItem(`entity${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)}Json`);
    const savedEntityId = localStorage.getItem(`entity${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)}Id`);
    
    if (savedJson) {
      try {
        initialValue = JSON.parse(savedJson);
      } catch (e) {
        console.warn('Could not parse saved JSON, using template instead', e);
        initialValue = entityTemplates[currentMode];
      }
    } else {
      initialValue = entityTemplates[currentMode];
    }
    
    if (savedEntityId && ['get', 'put', 'patch', 'delete'].includes(currentMode)) {
      entityId = savedEntityId;
    } else if (['put', 'patch'].includes(currentMode)) {
      // For PUT/PATCH, extract ID from template if no saved ID
      entityId = initialValue.id || '';
    }
    
    // If a previous editor instance exists, destroy it
    if (editorInstance) {
      // Nothing to do here, the DOM will be replaced
      editorInstance = null;
    }
    
    // Clear the container
    const container = document.getElementById('jsonEditorContainer');
    container.innerHTML = '';
    
    // For GET and DELETE, we need to add an entity ID input field
    if (['get', 'delete'].includes(currentMode)) {
      const idInputSection = document.createElement('div');
      idInputSection.className = 'entity-id-section';
      
      const inputLabel = document.createElement('label');
      inputLabel.htmlFor = 'entityIdInput';
      inputLabel.textContent = currentMode === 'get' ? 'Entity ID or Query:' : 'Entity ID:';
      inputLabel.style.fontWeight = 'bold';
      inputLabel.style.display = 'block';
      inputLabel.style.marginBottom = '5px';
      
      const idInput = document.createElement('input');
      idInput.type = 'text';
      idInput.id = 'entityIdInput';
      idInput.className = 'entity-id-input';
      idInput.placeholder = currentMode === 'get' 
        ? 'urn:ngsi-ld:Entity:001 or ?type=Device&limit=10' 
        : 'urn:ngsi-ld:Entity:001';
      idInput.value = entityId;
      
      idInput.addEventListener('input', function() {
        entityId = this.value;
        localStorage.setItem(`entity${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)}Id`, entityId);
      });
      
      const actionButton = document.createElement('button');
      actionButton.textContent = currentMode.toUpperCase();
      actionButton.className = `method-button ${currentMode}-button`;
      actionButton.style.marginTop = '10px';
      
      actionButton.addEventListener('click', function() {
        if (!entityId) {
          alert(`Entity ID or query is required for ${currentMode.toUpperCase()} operation.`);
          return;
        }
        
        if (currentMode === 'get') {
          handleEntityGet(entityId);
        } else if (currentMode === 'delete') {
          if (confirm(`Are you sure you want to delete entity "${entityId}"? This action cannot be undone.`)) {
            handleEntityDelete(entityId);
          }
        }
      });
      
      idInputSection.appendChild(inputLabel);
      idInputSection.appendChild(idInput);
      idInputSection.appendChild(document.createElement('br'));
      idInputSection.appendChild(actionButton);
      
      container.appendChild(idInputSection);
    }
    
    try {
      // For GET and DELETE modes, we show a basic read-only text view
      if (['get', 'delete'].includes(currentMode)) {
        const jsonDisplay = document.createElement('pre');
        jsonDisplay.className = 'json-display';
        jsonDisplay.style.marginTop = '20px';
        jsonDisplay.style.padding = '10px';
        jsonDisplay.style.backgroundColor = '#f8f8f8';
        jsonDisplay.style.border = '1px solid #ddd';
        jsonDisplay.style.borderRadius = '4px';
        jsonDisplay.style.maxHeight = '600px'; // Increased from 400px to 600px
        jsonDisplay.style.height = 'calc(100vh - 250px)'; // Make it responsive to viewport height
        jsonDisplay.style.overflowY = 'auto';
        jsonDisplay.textContent = JSON.stringify(initialValue, null, 2);
        
        container.appendChild(jsonDisplay);
        
        // For GET mode, store the jsonDisplay element for later updates
        if (currentMode === 'get') {
          window.getResultsDisplay = jsonDisplay;
        }
      } else {
        // Create a new JsonEditor instance with the appropriate mode
        editorInstance = new JsonEditor({
          containerId: 'jsonEditorContainer',
          initialValue: JSON.stringify(initialValue, null, 2),
          height: 500,
          resize: true,
          mode: currentMode,
          entityId: entityId,
          onEntityAction: handleEntityAction,
          onSave: function(value) {
            try {
              const parsedValue = JSON.parse(value);
              // Save to localStorage for persistence
              localStorage.setItem(`entity${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)}Json`, JSON.stringify(parsedValue));
              console.log(`Saved ${currentMode} JSON to localStorage`);
            } catch (e) {
              console.error('Error saving JSON to localStorage:', e);
            }
          }
        });
      }
      
      console.log(`Initialized editor in ${currentMode} mode with entityId: ${entityId}`);
      updateDescription();
      
    } catch (e) {
      console.error('Error initializing editor:', e);
      showErrorMessage('Error initializing editor: ' + e.message);
    }
  }
  
  // Handle GET operation
  function handleEntityGet(idOrQuery) {
    console.log(`Getting entity/entities with: ${idOrQuery}`);
    
    try {
      // Update display to show loading
      if (window.getResultsDisplay) {
        window.getResultsDisplay.textContent = 'Loading...';
      }
      
      // Determine if this is an ID or a query
      if (idOrQuery.startsWith('?')) {
        // This is a query string
        if (typeof window.handleGetQuery === 'function') {
          window.handleGetQuery(idOrQuery);
        } else {
          throw new Error('handleGetQuery function not available');
        }
      } else {
        // This is an entity ID
        if (typeof window.handleEntityGet === 'function') {
          window.handleEntityGet(idOrQuery);
        } else {
          throw new Error('handleEntityGet function not available');
        }
      }
    } catch (error) {
      console.error('Error performing GET operation:', error);
      alert('Error: ' + error.message);
      
      if (window.getResultsDisplay) {
        window.getResultsDisplay.textContent = `Error: ${error.message}`;
      }
    }
  }
  
  // Handle DELETE operation
  function handleEntityDelete(entityId) {
    console.log(`Deleting entity: ${entityId}`);
    
    try {
      if (typeof window.processDeleteQuery === 'function') {
        window.processDeleteQuery(entityId);
      } else {
        throw new Error('processDeleteQuery function not available');
      }
    } catch (error) {
      console.error('Error performing DELETE operation:', error);
      alert('Error: ' + error.message);
    }
  }
  
  // Handle entity operations (Create, Update, Patch)
  function handleEntityAction(action) {
    try {
      console.log('Entity action:', action);
      
      if (!action.data) {
        throw new Error('No entity data provided.');
      }
      
      // For PUT and PATCH, verify entity ID is provided
      if (['put', 'patch'].includes(action.mode) && !action.entityId) {
        throw new Error('Entity ID is required for PUT and PATCH operations.');
      }
      
      // Save entity ID to localStorage
      if (action.entityId) {
        localStorage.setItem(`entity${action.mode.charAt(0).toUpperCase() + action.mode.slice(1)}Id`, action.entityId);
      }
      
      // Handle different operations
      switch (action.mode) {
        case 'post':
          console.log('Creating entity:', action.data);
          // Call the API function for entity creation
          if (typeof window.processPostQuery === 'function') {
            window.processPostQuery(JSON.stringify(action.data));
          } else {
            console.error('processPostQuery function not available');
            alert('API function for entity creation is not available.');
          }
          break;
          
        case 'put':
          console.log(`Updating entity ${action.entityId}:`, action.data);
          // Call the API function for entity update
          if (typeof window.processPutQuery === 'function') {
            window.processPutQuery(action.entityId, JSON.stringify(action.data));
          } else {
            console.error('processPutQuery function not available');
            alert('API function for entity update is not available.');
          }
          break;
          
        case 'patch':
          console.log(`Patching entity ${action.entityId}:`, action.data);
          // Call the API function for entity patch
          if (typeof window.processPatchQuery === 'function') {
            window.processPatchQuery(action.entityId, JSON.stringify(action.data));
          } else {
            console.error('processPatchQuery function not available');
            alert('API function for entity patch is not available.');
          }
          break;
          
        default:
          throw new Error(`Unsupported operation mode: ${action.mode}`);
      }
      
    } catch (error) {
      console.error('Error performing entity operation:', error);
      alert('Error: ' + error.message);
    }
  }
  
  // Update GET results display
  window.updateGetResults = function(results) {
    if (window.getResultsDisplay) {
      try {
        // If results is already a string, use it directly, otherwise stringify it
        const displayText = typeof results === 'string' 
          ? results 
          : JSON.stringify(results, null, 2);
          
        window.getResultsDisplay.textContent = displayText;
      } catch (e) {
        console.error('Error updating GET results:', e);
        window.getResultsDisplay.textContent = 'Error displaying results: ' + e.message;
      }
    }
  };
  
  // Helper function to show error messages
  function showErrorMessage(message) {
    const container = document.getElementById('jsonEditorContainer');
    const errorDiv = document.createElement('div');
    errorDiv.classList.add('network-error');
    errorDiv.textContent = 'Error: ' + message;
    container.appendChild(errorDiv);
  }
</script>