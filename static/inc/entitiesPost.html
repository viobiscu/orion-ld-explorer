<div class="form-container">
  <div class="form-header">
    <button class="method-button post-button" onclick="postEntity()">POST</button>
  </div>
  <div class="form-body">
    <div id="jsonEditorContainer"></div>
  </div>
  <div class="form-footer">
    <small>This form creates a new entity in the Orion-LD Context Broker.</small>
  </div>
</div>

<script>
  // Add a non-module version of the JsonEditor script to make it globally available
  (function() {
    // Create a script element for the JsonEditor (as a non-module)
    const script = document.createElement('script');
    script.src = '/js/jsonEditor.js';
    script.type = 'text/javascript'; // Not module
    
    // Add the script to the header
    document.head.appendChild(script);
    
    // Set a delay to ensure the script is loaded before initializing
    setTimeout(initializeEditor, 200);
    
    function initializeEditor() {
      // Initial JSON value for the entity
      const initialJSON = {
        "id": "urn:ngsi-ld:TG8I:240825003",
        "type": "TG8I",
        "@context": [
          "http://ngsi-ld.sensorsreport.net/synchro-context.jsonld"
        ],
        "APIKey": {
          "type": "Property",
          "value": "dP1JO6"
        },
        "accessPointName": {
          "type": "Property",
          "value": "Synchro-WiFi"
        },
        "accessPointPassword": {
          "type": "Property",
          "value": "supersecure"
        },
        "dhcp": {
          "type": "Property",
          "value": true
        },
        "timestamp": {
          "type": "Property",
          "value": "2025-04-02T10:15:00Z"
        }
      };
      
      // Check if JsonEditor is available
      if (typeof window.JsonEditor !== 'function') {
        console.error('JsonEditor component not found. Attempting to load it directly...');
        
        // Try a more direct approach to get the JsonEditor
        fetch('/js/jsonEditor.js')
          .then(response => response.text())
          .then(code => {
            // Execute the code directly
            const scriptElement = document.createElement('script');
            scriptElement.textContent = code.replace('export default JsonEditor;', ''); // Remove the export
            document.body.appendChild(scriptElement);
            
            // Try initializing again after a short delay
            setTimeout(() => {
              if (typeof window.JsonEditor === 'function') {
                console.log('JsonEditor successfully loaded directly');
                createEditor(initialJSON);
              } else {
                showErrorMessage('Failed to load the JSON Editor component. Please refresh the page.');
              }
            }, 100);
          })
          .catch(error => {
            console.error('Failed to load JsonEditor directly:', error);
            showErrorMessage('Failed to load the JSON Editor component. Please refresh the page.');
          });
      } else {
        console.log('JsonEditor is available, initializing editor');
        createEditor(initialJSON);
      }
    }
    
    function createEditor(initialJSON) {
      // Initialize the editor with the container ID and initial value
      try {
        window.editor = new JsonEditor({
          containerId: 'jsonEditorContainer',
          initialValue: JSON.stringify(initialJSON, null, 2),
          height: 500,
          resize: true,
          onSave: function(value) {
            // Save the content to localStorage for persistence
            localStorage.setItem('entityPostJson', value);
          }
        });
        
        // Load saved content if available
        const savedJson = localStorage.getItem('entityPostJson');
        if (savedJson) {
          window.editor.setValue(savedJson);
        }
        
        console.log('Editor initialized successfully');
      } catch (e) {
        console.error('Error initializing editor:', e);
        showErrorMessage('Error initializing editor: ' + e.message);
      }
    }
    
    function showErrorMessage(message) {
      const errorDiv = document.createElement('div');
      errorDiv.classList.add('network-error');
      errorDiv.textContent = 'Error: ' + message;
      document.getElementById('jsonEditorContainer').appendChild(errorDiv);
    }
  })();

  // Function to post the entity
  function postEntity() {
    try {
      console.log('Post button clicked, editor availability:', !!window.editor);
      
      if (!window.editor) {
        throw new Error('JSON Editor not initialized. Please wait a moment and try again.');
      }
      
      // Validate JSON before submitting
      if (!window.editor.isValid()) {
        alert('Invalid JSON. Please correct the format before submitting.');
        return;
      }
      
      // Format the JSON one last time to ensure proper formatting
      window.editor.formatJson();
      
      // Get the JSON content and process it
      const jsonContent = window.editor.getValue();
      console.log('Posting entity with data:', jsonContent);
      
      // Call the API function to post the entity
      processPostQuery(jsonContent);
    } catch (error) {
      console.error('Error posting entity:', error);
      alert('Error: ' + error.message);
    }
  }
</script>

