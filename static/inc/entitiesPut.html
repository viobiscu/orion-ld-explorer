<div class="form-container">
  <div class="form-header">
    <button class="method-button put-button" onclick="putEntity()">PUT</button>
  </div>
  <div class="form-body">
    <label for="entityPutInput">Entity ID:</label>
    <input type="text" id="entityPutInput" class="input" placeholder="Enter the entity ID" value="urn:ngsi-ld:TG8I:240825003">
    <div id="jsonEditorContainer"></div>
  </div>
  <div class="form-footer">
    <small>This form replaces an entity in the Orion-LD Context Broker.</small>
  </div>
</div>

<script>
  // Add a non-module version of the JsonEditor script to make it globally available
  (function() {
    // Create a script element for the JsonEditor (as a non-module)
    const script = document.createElement('script');
    script.src = '/js/jsonEditor.js';
    script.type = 'text/javascript'; // Not module
    
    // Add the script to the header
    document.head.appendChild(script);
    
    // Set a delay to ensure the script is loaded before initializing
    setTimeout(initializeEditor, 200);
    
    function initializeEditor() {
      // Initial JSON value for the entity
      const initialJSON = {
        "id": "urn:ngsi-ld:TG8I:240825003",
        "type": "TG8I",
        "@context": [
          "http://ngsi-ld.sensorsreport.net/synchro-context.jsonld"
        ],
        "APIKey": {
          "type": "Property",
          "value": "dP1JO6"
        },
        "accessPointName": {
          "type": "Property",
          "value": "Synchro-WiFi"
        },
        "accessPointPassword": {
          "type": "Property",
          "value": "supersecure"
        },
        "dhcp": {
          "type": "Property",
          "value": true
        },
        "gw": {
          "type": "Property",
          "value": "192.168.1.1"
        },
        "nm": {
          "type": "Property",
          "value": "255.255.255.0"
        },
        "mac": {
          "type": "Property",
          "value": "00:1A:2B:3C:4D:5E"
        },
        "missedTX": {
          "type": "Property",
          "value": 0
        },
        "otaFileName": {
          "type": "Property",
          "value": "firmware_v1.2.bin"
        },
        "otaHostName": {
          "type": "Property",
          "value": "ota.synchro-srl.ro"
        },
        "otaPort": {
          "type": "Property",
          "value": 8080
        },
        "power": {
          "type": "Property",
          "value": true
        },
        "rssi": {
          "type": "Property",
          "value": -55
        },
        "rx": {
          "type": "Property",
          "value": 100
        },
        "tx": {
          "type": "Property",
          "value": 4
        },
        "sampleTime": {
          "type": "Property",
          "value": 900
        },
        "vbat": {
          "type": "Property",
          "value": 3.7
        },
        "timestamp": {
          "type": "Property",
          "value": "2025-04-02T10:15:00Z"
        }
      };
      
      // Check if JsonEditor is available
      if (typeof window.JsonEditor !== 'function') {
        console.error('JsonEditor component not found. Attempting to load it directly...');
        
        // Try a more direct approach to get the JsonEditor
        fetch('/js/jsonEditor.js')
          .then(response => response.text())
          .then(code => {
            // Execute the code directly
            const scriptElement = document.createElement('script');
            scriptElement.textContent = code;
            document.body.appendChild(scriptElement);
            
            // Try initializing again after a short delay
            setTimeout(() => {
              if (typeof window.JsonEditor === 'function') {
                console.log('JsonEditor successfully loaded directly');
                createEditor(initialJSON);
              } else {
                showErrorMessage('Failed to load the JSON Editor component. Please refresh the page.');
              }
            }, 100);
          })
          .catch(error => {
            console.error('Failed to load JsonEditor directly:', error);
            showErrorMessage('Failed to load the JSON Editor component. Please refresh the page.');
          });
      } else {
        console.log('JsonEditor is available, initializing editor');
        createEditor(initialJSON);
      }
    }
    
    function createEditor(initialJSON) {
      // Initialize the editor with the container ID and initial value
      try {
        // Load saved entity ID if available
        const savedEntityId = localStorage.getItem('entityPutInputText');
        if (savedEntityId) {
          document.getElementById('entityPutInput').value = savedEntityId;
        }
        
        window.editor = new JsonEditor({
          containerId: 'jsonEditorContainer',
          initialValue: JSON.stringify(initialJSON, null, 2),
          height: 500,
          resize: true,
          onSave: function(value) {
            // Save the content to localStorage for persistence
            localStorage.setItem('jsonDisplay', value);
          }
        });
        
        // Load saved content if available
        const savedJson = localStorage.getItem('jsonDisplay');
        if (savedJson) {
          window.editor.setValue(savedJson);
        }
        
        // Set up entity ID field to save its value on change
        const entityInput = document.getElementById('entityPutInput');
        if (entityInput) {
          entityInput.addEventListener('input', function() {
            localStorage.setItem('entityPutInputText', this.value);
          });
        }
        
        console.log('Editor initialized successfully');
      } catch (e) {
        console.error('Error initializing editor:', e);
        showErrorMessage('Error initializing editor: ' + e.message);
      }
    }
    
    function showErrorMessage(message) {
      const errorDiv = document.createElement('div');
      errorDiv.classList.add('network-error');
      errorDiv.textContent = 'Error: ' + message;
      document.getElementById('jsonEditorContainer').appendChild(errorDiv);
    }
  })();

  // Function to put the entity
  function putEntity() {
    try {
      console.log('PUT button clicked, editor availability:', !!window.editor);
      
      if (!window.editor) {
        throw new Error('JSON Editor not initialized. Please wait a moment and try again.');
      }
      
      // Validate JSON before submitting
      if (!window.editor.isValid()) {
        alert('Invalid JSON. Please correct the format before submitting.');
        return;
      }
      
      // Format the JSON one last time to ensure proper formatting
      window.editor.formatJson();
      
      // Get the entity ID and JSON content
      const entityId = document.getElementById('entityPutInput').value;
      const jsonContent = window.editor.getValue();
      
      if (!entityId) {
        alert('Entity ID is required');
        return;
      }
      
      console.log(`Putting entity ${entityId} with data:`, jsonContent);
      
      // Call the API function to put the entity
      handlePatchQuery(entityId, jsonContent);
    } catch (error) {
      console.error('Error updating entity:', error);
      alert('Error: ' + error.message);
    }
  }
</script>

